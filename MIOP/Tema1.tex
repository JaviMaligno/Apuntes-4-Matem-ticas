\documentclass[MIOP.tex]{subfiles}
\begin{document}

\chapter{Introducción a la Programación\\ Dinámica.}
\section{Introducción.}
La Programación Dinámica (P.D.) son un conjunto de técnicas que permiten resolver procesos de división secuencial.
\begin{ej}
Probabilidad de que al lanzar dos dados sucesivamente tengan antes un suceso que sume 3 a uno que sume 7. Llamemos $A=$``obtener un suceso que sume 3 antes que uno que suma 7''. Tratamos de expresar la probabilidad recursivamente. 

$P(A)=P(A/1er$ lanzamiento suma $3)P(1er$ lanzamiento suma 3$)+P(A/1er$ lanzamiento suma $7)P(1er$ lanzamiento suma $7)+P(A/1er$ lanzamiento no suma ninguno$)P(1er$ lanzamiento no suma ninguno$)$. Sustituyendo por su valor:
$$P(A)=1\cdot\frac{2}{36}+0\cdot\frac{6}{36}+P(A)\frac{28}{36}=\frac{2}{36}+P(A)\frac{28}{36}.$$
Podemos despejar y obtenemos $P(A)=\dfrac{1}{4}$. 
\end{ej}

\begin{ej}
Calcular el factorial de un número recursivamente. Entonces $f(n)=n!=nf(n-1)$. Si sabemos que $f(0)=1$ podemos calcularla para cualquier $n\in\N$.
\end{ej}

\begin{ej}
(Dibujo de Rafa)
Calcular el camino más corto para ir de $1$ hasta $7$. Para llegar al nodo $7$, necesariamente hay que pasar por uno de los $3$ a los que está conectado. Llamamos $l_{ij}$ a la longitud del arco $(i,j)$. Si definimos $f(i)=$``longitud del camino más corto desde $i$ hasta $7$''. Sabemos que $f(7)=0$. 
\[
\begin{tikzpicture}
    \node[shape=circle,draw=black] (A) at (0,1.5) {$1$};
    \node[shape=circle,draw=black] (C) at (2,0) {$3$};    
    \node[shape=circle,draw=black] (B) at (2,3) {$2$};
    \node[shape=circle,draw=black] (D) at (4,3) {$4$};
    \node[shape=circle,draw=black] (E) at (4,0) {$6$};
    \node[shape=circle,draw=black] (F) at (5,1.5) {$5$};
    \node[shape=circle,draw=black] (G) at (7,1.5) {$7$};
\tikzset{mystyle/.style={->,double=blue}} 
\tikzset{every node/.style={fill=white}} 
     \path [->] (A) edge node {$1.5$} (B);
     \path [->] (A) edge [mystyle]  node {$2$} (C);
     \path [->] (B) edge node {$2$} (C);
     \path [->] (B) edge node {$1$} (F);
     \path [->] (B) edge node {$2$} (E);
     \path [->] (B) edge node {$3$} (D);
     \path [->] (C) edge [mystyle]  node {$1$} (E);
     \path [->] (C) edge node {$1$} (F);
     \path [->] (D) edge node {$3$} (F);
     \path [->] (D) edge node {$1$} (G);
     \path [->] (E) edge [mystyle] node {$1$} (G);
     \path [->] (F) edge node {$3$} (G);
	 \path [->] (E) edge node {$3$} (F);
\end{tikzpicture}
\]
\begin{align*}
f(4)=&\min\{l_{47},l_{45}+f(5)\}=\min\{1,6\}=1\\
f(5)=&\min\{l_{57}\}=3\\
f(6)=&\min\{l_{67},f(5)+l_{65}\}=\min\{1,3+3\}=1\\
f(3)=&\min\{l_{35}+f(5),l_{36}+f(6)\}=\min\{1+3,1+2\}=3\\
f(2)=&\min\{l_{24}+f(4),l_{25}+f(5),l_{26}+f(6),l_{23}+f(3)\}=\min\{3+1,1+3,2+1,2+2\}=3\\
f(1)=&\min\{l_{12}+f(2),l_{13}+f(3)\}=\min\{1.5+3,2+2\}=4
\end{align*}

Tenemos que el camino más corto tiene longitud $4$ y se corresponde con el camino $1->3->6->7$. Sea $\Gamma(i)=\{j:\exists (i,j)$ en el grafo$\}$. Entonces $f(7)=0$ y $f(i)=\min_{j\in\Gamma(i)}\{l_{ij}+f(j)\}\forall j\neq 7$.

\end{ej}

\subsection{Elementos de P.D.}
\begin{enumerate}
\item El problema se puede descomponer en subproblemas (etapas) y debemos tomar una decisión en cada uno de ellos.
\item En cada etapa hay un número finito de estados.
\item La decisión que se realiza en un estado determina la transición al estado en la etapa siguiente.
\item En un estado, la decisión óptima de los problemas en etapas futuras no depende de las decisiones anteriores. 
\item Debe existir un funcional $f$ que relacióna el valor de un subproblema en la etapa $k$ con el de la etapa $k+1$ (o $k-1$). 
\end{enumerate}

Denotemos por $s_k$ la variable que denota el estado en la etapa $k$. Sea $d_k$ una decisión factible en el estado $s_k$ y $c_k(s_k,d_k)$ el coste incurrido en el estado $k$ si se decide $d_k$. Asimismo, sea $t_k(s_k,d_k)$ el estado al que evoluciona el sistema en la etapa $k+1$ si en $s_k$ se decide $d_k$.

Usando el ejemplo anterior:
\begin{itemize}
\item $s=$nodo.
\item decisiones: $d\in\Gamma(i)$.
\item $c(i,d)=l_{id}$.
\item $t(i,d)=d$.
\end{itemize}

\textbf{Diagrama de cajas}
(dibujo de Rafa)
Etapa $k$:
$\overset{d_k}{\longrightarrow}\boxed{s_k}\rightarrow c_k(s_k,d_k)$\\
Etapa $k$:
$\overset{d_k}{\longrightarrow}\boxed{t_k(s_k,d_k)}\rightarrow c_k(s_{k+1},d_{k+1})$

\begin{defi}
Sea $g:\R^n\to\R$. Decimos que $g$ es \textbf{separable} si $\exists g_1:\R^2\to\R,g_2:\R^{n-1}\to\R$ tales que $g(u_1,u_2,\dots,u_n)=g_1(u_1,g_2(u_2,\dots,u_n))$. 
\end{defi}

\begin{defi}
$g:\R^n\to\R$ es descomponible si
\begin{enumerate}
\item Es separable con $g_1,g_2$ y
\item $g_1$ es monótona no creciente como función de $g_2$ (en proceso de minimización, no decreciente si es maximización). 
\end{enumerate}
\end{defi}

\begin{ej}
Suma, producto de números positivos, máximo... 
\end{ej}

\begin{teorema}[Mitten] 
Sea $g:\R^n\to\R$ una función descomponible con $g_1,g_2$. Asumimos que nos movemos en dominios compactos y las funciones son continuas, de modo que se alcanzan los mínimos. Entonces se verifica:
$$\min_{r_1,r_2,\dots,r_n} g(r_1,r_2,\dots,r_n)=\min_{r_1} g_1(r_1,\min_{r_2,\dots,r_n}g_2(r_2,\dots,r_n))$$

\end{teorema}
\begin{dem}
Dado que $\forall u_1,\dots, u_n$ $g(u_1,\dots, u_n)=g_1(u_1,g_2(u_2,\dots, u_n))$. Entonces $$\min_{r_1,\dots,r_n}g(r_1,\dots,r_n)\leq g_1(u_1,g_2(u_2,\dots, u_n))\forall u_1,u_2,\dots,u_n.$$ Por tanto, $$\min_{r_1,\dots,r_n}g(r_1,\dots,r_n)\leq g_1(u_1,\min_{u_2,\dots,u_n}g_2(u_2,\dots, u_n))\forall u_1.$$ Luego $$\min_{r_1,\dots,r_n}g(r_1,\dots,r_n)\leq \min_{u_1}g_1(u_1,\min_{u_2,\dots,u_n}g_2(u_2,\dots, u_n)).$$
Análogamente, usando que $g_1$ es no creciente en $g_2$, $$g(u_1,\dots, u_n)\geq g_1(u_1,\min_{r_2,\dots,r_n}g_2(r_2,\dots,r_n))\forall u_1.$$ Por consiguiente, 
$$g(u_1,\dots, u_n)\geq \min_{r_1}g_1(r_1,\min_{r_2,\dots,r_n}g_2(r_2,\dots,r_n)).$$ Finalmente,
$$\min_{u_1,\dots,u_n}g(u_1,\dots, u_n)\geq \min_{r_1}g_1(r_1,\min_{r_2,\dots,r_n}g_2(r_2,\dots,r_n)).$$\QED
\end{dem}

\section{Ecuaciones de un proceso de decisión.}
Consideremos un proceso de decisión secuencial en $N$ etapas y denotemos por $s_n$ el estado en la etapa $n$. Supongamos que conocemos el estado final del proceso $s_N^*$. Sean $c_n(s_n,d_n)$ y $t_n(s_n,d_n)$, respectivamente, las funciones de coste entre etapas. Finalmente, supongamos que $f_n(s_n)$ representa el menor coste para ``conducir'' al sistema desde la etapa $n$ en estado $s_n$ hasta $s_N^*$. Entonces, podemos escribir $f_n(s_n)=\min_{d_n}\{c_n(s_n,d_n)+f_{n+1}(t_n(s_n,d_n))\}\ n<N$. Y para $n=N$, $f_N(s_N)=\begin{cases}
+\infty & s_N\neq s_N^*\\
\min_{d_N}c_N(s_N^*, d_N) & s_N=s_N^*
\end{cases}$

Estas ecuaciones se pueden extender a otras funciones $g$ siempre que sean descomponibles.
$f_n(s_n)=\min_{d_n}\{g_1(c_n(s_n,d_n)),f_{n+1}(t_n(s_n,d_n))\}$.
\begin{ejer}[Problema de producción e inventario]
Consideremos un proceso de producción en $T$ etapas, $t=1,2\dots,T$. En la etapa $t$ existe una demanda $d_t$ que hay que satisfacer. En cada etapa se puede decidir producir $x$ unidades  con un coste $c_t(x)$. Además existe un coste de almacén $h_t(I_t)$, que representa el coste en el periodo $t$ por tener $I_t$ unidades al comienzo de este periodo. Suponemos que $I_1=0=I_{T+1}$.  En estado $I_t$, $f_t(I_t)$ es el mínimo coste para atender la demanda desde $t$ a $T$ si en $t$ tengo $I_t$ en inventario. Entonces $f_t(I_t)=\min_{x_t}\{c_t(I_t,x_t)+f_{t+1}(I_t+x-d_t)+h_t(I_t)\}$ si $t<T+1$ y $f_{T+1}=\begin{cases}
+\infty & I_{T+1}>0\\
0 & I_{T+1}=0
\end{cases}$

Donde $x_t$ son las unidades producidas en la etapa $t$ y $d_t$ la demanda en la etapa $t$. La solución del problema es $f_1(0)$. Resolver el problema con los siguientes datos.

\begin{tabular}{|c| c c c c|}
\hline
$t$ & $1$ & $2$ & $3$ & $4$\\
\hline
$d_t$ & $1$ & $3$ & $2$ & $4$\\
\hline

\end{tabular}

$I_1=I_5=0$, $h_t(I)=\frac{1}{2}I$ ($I\leq 4$), $c_t(x)=\begin{cases}
3+x & 5\geq x>0\\
0 & x=0
\end{cases}$
\end{ejer}
\begin{solucion}
\underline{Etapa 4:}\

\begin{tabular}{|c| c| c| c |}
\hline
$I$ & $x$ & $f_4(I)$ & $x^* $ \\
\hline
$0$ & $4$ & $7$ &  \\
\hline
$1$ & $3$ & $\frac{1}{2}1+6$ & \\
\hline
$2$ & $2$ & $\frac{1}{2}2+5$ & \\
\hline
$3$ & $1$ & $\frac{1}{2}3+4$ &  \\
\hline
$4$ & $0$ & $\frac{1}{2}4+0$ & $\boxed{2}$ \\
\hline
\end{tabular}\
\\

\underline{Etapa 3:}\

\begin{tabular}{|c| c| c| c | c| c|}
\hline
$I$ & $x$ & $\frac{1}{2}I+c(x)$ & $f_4(I-2+x)$ &  $f_3(I)$ & $x^* $ \\
\hline
$0$ & $2$ & $5$ & $7$  & $12$& $\boxed{2}$\\
\hline
 & $3$ & $0+6$ &$6,5$ & $12,5$ &\\
\hline
 & $4$ & $0+7$ & $6$ & $13$&\\
\hline
 & $5$ & $0+8$ & $5,5$ & $13,5$ & \\
\hline
\hline
$1$ & $1$ & $\frac{1}{2}+4$ & $7$  & $11,5$& $\boxed{1}$\\
\hline
 & $2$ & $\frac{1}{2}+5$ &$6,5$ & $12$ &\\
\hline
 & $3$ & $\frac{1}{2}+6$ & $6$ & $12,5$&\\
\hline
 & $4$ & $\frac{1}{2}+7$ & $5,5$ & $13$ & \\
\hline
 & $5$ & $\frac{1}{2}+8$ & $2$ & $13,5$ & \\
\hline
\hline
$2$ & $0$ & $\frac{1}{2}2+0$ & $7$  & $8$& $\boxed{0}$\\
\hline
 & $1$ & $\frac{1}{2}2+4$ &$6,5$ & $11,5$ &\\
\hline
 & $2$ & $\frac{1}{2}2+5$ &$6$ & $12$ &\\
\hline
 & $3$ & $\frac{1}{2}2+6$ & $5,5$ & $12,5$&\\
\hline
 & $4$ & $\frac{1}{2}2+7$ & $2$ & $10$ & \\
\hline
\hline
$3$ & $0$ & $\frac{1}{2}3+0$ & $6,5$  & $8$ & $\boxed{0}$\\
\hline
 & $1$ & $\frac{1}{2}3+4$ &$6$ & $11,5$ &\\
\hline
 & $2$ & $\frac{1}{2}3+5$ &$5,5$ & $12$ &\\
\hline
 & $3$ & $\frac{1}{2}3+6$ & $2$ & $9,5$&\\
 \hline
 \hline
 $4$ & $0$ & $\frac{1}{2}4+0$ & $6$  & $8$& $\boxed{0}$\\
\hline
 & $1$ & $\frac{1}{2}4+4$ &$5,5$ & $11,5$ &\\
\hline
 & $2$ & $\frac{1}{2}4+5$ &$2$ & $9$ &\\
 \hline
\end{tabular}\
\newpage

\underline{Etapa 2:}\

\begin{tabular}{|c| c| c| c | c| c|}
\hline
$I$ & $x$ & $\frac{1}{2}I+c(x)$ & $f_3(I-3+x)$ &  $f_2(I)$ & $x^* $ \\
\hline
$0$ & $3$ & $0+6$ &  $12$  & $18$& \\
\hline
 & $4$ & $0+7$ &$11,5$ & $18,5$ &\\
\hline
 & $5$ & $0+8$ & $8$ & $16$& $\boxed{5}$\\
\hline
\hline
$1$ & $2$ & $\frac{1}{2}+5$ & $12$  & $17,5$& \\
\hline
 & $3$ & $\frac{1}{2}+6$ &$11,5$ & $18$ &\\
\hline
 & $4$ & $\frac{1}{2}+7$ & $8$ & $15,5$& $\boxed{4}$\\
\hline
 & $5$ & $\frac{1}{2}+8$ & $8$ & $16,5$ & \\
\hline
\hline
$2$ & $1$ & $\frac{1}{2}2+4$ & $12$  & $17$& \\
\hline
 & $2$ & $\frac{1}{2}2+5$ &$11,5$ & $17,5$ &\\
\hline
 & $3$ & $\frac{1}{2}2+6$ &$8$ & $15$ &$\boxed{3}$\\
\hline
 & $4$ & $\frac{1}{2}2+7$ & $8$ & $16$&\\
\hline
 & $5$ & $\frac{1}{2}2+8$ & $8$ & $17$ & \\
\hline
\hline
$3$ & $0$ & $\frac{1}{2}3+0$ & $12$  & $13,5$ & $\boxed{0}$\\
\hline
 & $1$ & $\frac{1}{2}3+4$ &$11,5$ & $17$ &\\
\hline
 & $2$ & $\frac{1}{2}3+5$ &$8$ & $14,5$ &\\
\hline
 & $3$ & $\frac{1}{2}3+6$ & $8$ & $15,5$&\\
 \hline
 & $4$ & $\frac{1}{2}3+7$ & $8$ & $16,5$&\\
 \hline
 \hline
 $4$ & $0$ & $\frac{1}{2}4+0$ & $13,5$  & $8$& $\boxed{0}$\\
\hline
 & $1$ & $\frac{1}{2}4+4$ &$8$ & $14$ &\\
\hline
 & $2$ & $\frac{1}{2}4+5$ &$8$ & $15$ &\\
 \hline
  & $3$ & $\frac{1}{2}4+6$ &$8$ & $16$ &\\
 \hline
\end{tabular}\
\\

\underline{Etapa 1:}\

\begin{tabular}{|c| c| c| c | c| c|}
\hline
$I$ & $x$ & $\frac{1}{2}I+c(x)$ & $f_2(I-1+x)$ &  $f_1(I)$ & $x^* $ \\
\hline
$0$ & $1$ & $0+4$ &  $16$  & $20$& $\boxed{1}$ \\
\hline
 & $2$ & $0+5$ &$15,5$ & $20,5$ &\\
\hline
 & $3$ & $0+6$ & $15$ & $21$& \\
 \hline
 & $4$ & $0+7$ & $13,5$ & $20,5$& \\
 \hline
 & $5$ & $0+8$ & $13,5$ & $21,5$& \\
\hline
\end{tabular}\

Partiendo del óptimo en la etapa $1$, construimos la solución general que es
$$x_1=1,x_2=5,x_3=0,x_4=4.$$
\end{solucion}
\subsection{Una reformulación alternativa}
Consideremos un grafo $(V,E)$ donde los nodos de $V$ son de la forma $(n,i)$, siendo $n$ la etapa del proceso, e $i$ el nivel inicial de inventario en esa etapa. Los arcos del grafo existen entre $(n,i)$ y $(n+1,i-d_n+x)$ $\forall x$ factible, y su coste cendrá dado por $h_n(i)+c_n(x)$. 

\[
\begin{tikzpicture}
 	\node[shape=rectangle,draw=black] (Z) at (-4,4) {$Etapa 1$};
 	\node[shape=rectangle,draw=black] (Y) at (-1,4) {$Etapa 2$};
 	\node[shape=rectangle,draw=black] (X) at (2,4) {$Etapa 3$};
 	\node[shape=rectangle,draw=black] (W) at (5,4) {$Etapa 4$};
 	
    \node[shape=circle,draw=black] (A) at (-4,3) {$1,0$};
    \node[shape=circle,draw=black] (B) at (-1,3) {$2,0$};
    \node[shape=circle,draw=black] (C) at (2,3) {$3,0$};
    \node[shape=circle,draw=black] (D) at (5,3) {$4,0$};  
      
    \node[shape=circle,draw=black] (E) at (7,3) {$5,0$}; 
    
    \node[shape=circle,draw=black] (B1) at (-1,1.5) {$2,1$};
    \node[shape=circle,draw=black] (C1) at (2,1.5) {$3,1$};
    \node[shape=circle,draw=black] (D1) at (5,1.5) {$4,1$};
    
    \node[shape=circle,draw=black] (B2) at (-1,0) {$2,2$};
    \node[shape=circle,draw=black] (C2) at (2,0) {$3,2$};
    \node[shape=circle,draw=black] (D2) at (5,0) {$4,2$};
    
    \node[shape=circle,draw=black] (B3) at (-1,-1.5) {$2,3$};
    \node[shape=circle,draw=black] (C3) at (2,-1.5) {$3,3$};
    \node[shape=circle,draw=black] (D3) at (5,-1.5) {$4,3$};
    
    \node[shape=circle,draw=black] (B4) at (-1,-3) {$2,4$};
    \node[shape=circle,draw=black] (C4) at (2,-3) {$3,4$};
    \node[shape=circle,draw=black] (D4) at (5,-3) {$4,4$};
    
    \node[draw=none, fill=none] (NOTA) at (2,-4) {$\text{El grafo se completa con el resto de pasos.}$};

\tikzset{every node/.style={fill=white}} 
     \path [->] (A) edge node {$0+4$} (B);
     \path [->] (A) edge node {$0+5$} (B1);
     \path [->] (A) edge node {$0+6$} (B2);
     \path [->] (A) edge node {$0+7$} (B3);
     \path [->] (A) edge node {$0+8$} (B4);
     \path [->] (B) edge node {$6$} (C);
     \path [->] (B1) edge node {$\frac{1}{2}+5$} (C);
     \path [->] (B2) edge node {$\frac{1}{2}2+4$} (C);

\end{tikzpicture}
\]


\subsection{Una reformulación con estados unidimensionales}
Estado $t\equiv$ etapa con inventario nulo en la que vamos a producir. $k$ es el número de etapas hasta la nueva producción. Por tanto, en $t$ se producirá la demanda acumulada desde $t$ hasta $t+k-1$, es decir, $\sum_{r=0}^{k-1}d_{t+r}$. El coste de producción en ese periodo es por tanto $c_t(\sum_{r=0}^{k-1}d_{t+r})\equiv c_{tk}$. El coste de inventario, al ir eliminando en cada caso una demanda,  sería 
$$h_{tk}=h_t(0)+h_{t+1}\left(\sum_{r=1}^{k-1}d_{t+r}\right)+h_{t+2}\left(\sum_{r=2}^{k-1}d_{t+r}\right)+\cdots +h_{t+k-1}(d_{t+k-1})=h_t(0)+\sum_{r=1}^{k-1}h_{t+r}\left(\sum_{l\geq r}^{k-1}d_{t+l}\right).$$

Entonces,  $f(t)=$ menor coste de producción en inventario desde etapa $t$ a $N$, si en $t$ tengo inventario vacío. La recurrencia quedaría de la siguiente forma:
\begin{align*}
&f(N)=h_N(0)+c_N(d_N),\\
&f(t)=\min_{k:t+k\leq N}\{c_{tk}+h_{tk}+f(t+k)\}, t<N.
\end{align*}

\begin{ej}[Problema de asignación de recursos] 
Qué cantidad de un recurso limitado $D$ asignar a activades $1,2,\dots, N$ de forma que se obtenga el mayor rendimiento. Denotamos por $r_i(d_i)$ al rendimiento de asignar $d_i$ unidades a la actividad $i$. El problema consiste en 
\begin{align*}
&\max \sum_{i=1}^N r_i(d_i)\\
&s.a.: \sum_{i=1}^N d_i\leq D\\
&      d_i\in\Z^+\ i=1,2,\dots,N
\end{align*}
Definimos $(n,d)$, donde $n$ es el índice de la primera actividad a la que no se le asignan recursos y $d$ son las unidades de recurso disponibles. La decisión $d_n$ es el número de unidades que se asigna a la actividad $n$. Como $f(n,d)$ representa el máximo rendimiento desde $n$ con $d$ unidades disponibles hasta $N$, la recursión queda definida como
\begin{align*}
&f(N,d)=\max_{d_N\leq d}\{r_N(d_N)\},\\
&f(n,d)=\max_{d_n\leq d}\{r_n(d_n)+f(n+1,d-d_n)\}.
\end{align*}
La solución al problema sería $f(1,D)$.
\end{ej}
\begin{ej} $D=6$, tareas $1,2,3$.

$r_1(x)=\begin{cases}
7x+2 & x>0\\
0 & x=0
\end{cases}$, $r_2(x)=\begin{cases}
3x+7 & x>0\\
0 & x=0
\end{cases}$, $r_3(x)=\begin{cases}
4x+5 & x>0\\
0 & x=0
\end{cases}.$

Hallar $f(1,6)$.


\end{ej}

\subsection{Un caso más simple}

$r_n(x)=r_nx$ $\forall n=1,\dots, N$. La restricción de capacidad está dada por un consumo de $w_n$ por cada unidad aplicada a la actividad $n$. 
\begin{align*}
&\max \sum_{n=1}^N r_nx_n\\
&s.a.: \sum_{i=n}^N w_nx_n\leq D\\
&      x_n\in\Z^+\ n=1,2,\dots,N
\end{align*}
Estado: $d=$ cantidad disponible de recursos. La función $g(d)$ será el máximo rendimiento si dispongo de $d$ unidades de recurso. 
\begin{align*}
&g(d)=\max_{w_n\leq d}\{r_n+g(d-w_n)\}
\end{align*}

\end{document}
